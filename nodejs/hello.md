# The hello example

In this example, we setup a `string` hello world WASM demo and demonstrate interaction with the browser's JS host. Since the `string` type is NOT natively supported by WASM, we use the `wasm-pack` and `wasm-bindgen` utilities to generate corresponding call stub objects in JS.

## Set up

```
$ sudo apt-get update
$ sudo apt-get -y upgrade
$ sudo apt install build-essential

$ curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
$ source $HOME/.cargo/env

$ curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
```


## Create new project

```
$ cargo new --lib hello
$ cd hello
```

## Change the cargo config file

Add the following to the [Cargo.toml](hello/Cargo.toml) file.

```
[lib]
name = "hello_lib"
path = "src/lib.rs"
crate-type =["cdylib"]

[dependencies]
wasm-bindgen = "0.2.50"
```

## Write Rust code

Below is the entire content of the [src/lib.rs](hello/src/lib.rs) file.

```
use wasm_bindgen::prelude::*;

#[wasm_bindgen]
pub fn say(s: String) -> String {
  let r = String::from("hello ");
  return r + &s;
}
```

## Build the WASM bytecode

```
$ wasm-pack build --target web
```

## Create a new Node folder

```
$ mkdir node
$ cp pkg/hello_lib_bg.wasm node/
$ cp pkg/hello_lib.js node/
$ cd node
```

Note the [hello_lib.js](hello/node/hello_lib.js) file is generated by `wasmp-apck` and contains the "glue code" to pass data between the JS host and WASM VM.
Because this file is designed to be used in browser, so we should make some change to let it run in Node.

Insert these two lines at the beginning:

```
const util = require('util');
const fs = require('fs');
```

Change the `new TextEncoder` to `new util.TextEncoder`.

Change the `new TextDecoder` to `new util.TextDecoder`.

Change the `export function say(s) {` to `function say(s) {`.

Replace the whole init function to:

```
function init(module) {
    if (typeof module === 'undefined') {
        module = __filename.replace(/\.js$/, '_bg.wasm');
    }
    const buf = fs.readFileSync(module);
    const imports = {};

    let result = WebAssembly.instantiate(buf, imports)
    .then(result => {
        if (result instanceof WebAssembly.Instance) {
            return { instance: result, module };
        } else {
            return result;
        }
    });

    return result.then(({instance, module}) => {
        wasm = instance.exports;
        init.__wbindgen_wasm_module = module;

        return wasm;
    });
}
```

In the end, replace the `export default init;` to `module.exports = { init, say };`.

## Create a node file

Below is the content of the [node/app.js](hello/node/app.js) file.

```
const { init, say } = require('./hello_lib.js');

(async () => {
  await init();
  console.log(say('World!'));
})();
```

## Test

```
node app.js
```
